<template>
  <form class="wrap create-top mt-[30px] max-md:mt-[50px] max-w-[1200px] w-full mx-auto max-xl:w-[90%] max-sm:w-[100%]">
    <div class="flex justify-between items-end mb-2">
        <h2 class="h1-title font-normal paperlogy text-primaryPoint">ê³µì§€ì‚¬í•­</h2>
    </div>
    <div class="border-t-[2px] border-primaryPoint mb-5"></div>
    <div class="gap-x-0 gap-y-0 text-left max-xl:grid-cols-1 mx-auto max-sm:p-0 p-10 bg-[#FFFFFF]">
        <!-- Row Template -->
      
      <!-- ê²Œì‹œíŒëª… -->
      <div class="px-2 bg-[#F9F9F9] border-b border-[#EFEFEF] h-[60px] flex items-center">
          <label class="width px-4 max-sm:px-2 text-[18px] after-small font-bold text-[#292929]">ì œëª©</label>
          <div class="flex-grow pt-2.5 font-semibold rounded-lg  text-semibold overflow-hidden whitespace-nowrap text-ellipsis truncate">
            {{ title }}
          </div>
      </div>
      <div class="px-2 bg-[#FFFFFF] border-b border-[#EFEFEF] h-[60px] flex items-center">
          <label
              class="width px-4 max-sm:px-2 text-[18px] after-small font-bold text-[#292929] whitespace-nowrap">ë“±ë¡ì¼</label>
          <div class="flex-grow flex gap-0">
            {{ created_at }}
          </div>
      </div>
        <!-- ê³µì§€ìƒíƒœ -->
      <div class="px-2 bg-[#F9F9F9] border-b border-t border-[#EFEFEF] h-[60px] flex items-center">
          <label
              class="width px-4 max-sm:px-2 text-[18px] after-small font-bold text-[#292929] whitespace-nowrap">ê³µì§€ìƒíƒœ</label>
          <div class="flex-grow flex gap-0">
            {{ type }}
          </div>
      </div>

      <!-- ì˜¤í”ˆìƒíƒœ -->
      <div class="px-2 bg-[#FFFFFF] border-b border-[#EFEFEF] h-[60px] flex items-center">
          <label
              class="width px-4 max-sm:px-2 text-[18px] after-small font-bold text-[#292929] whitespace-nowrap">ì˜¤í”ˆìƒíƒœ</label>
          <div class="flex-grow flex gap-0">
            {{ status }}
          </div>
      </div>
      
      

        <!-- ë‚´ìš© -->
        <div
            class="bg-[#F9F9F9] context-wrap px-2 flex items-center">
            <div class="context-label width max-sm:justify-start max-sm:w-full">
              <label class="px-4 max-sm:px-0 text-[18px] after-small font-bold text-[#292929] flex items-center py-4 xl:hidden">
                ë‚´ìš©
              </label>
            </div>
        </div>
        <div
          class="context-container max-xl:col-span-1 max-xl:flex max-xl:flex-col bg-[#F9F9F9] border-b border-[#EFEFEF] w-full grid grid-cols-6 p-2">
          <label
          class="tiny-mc col-span-1 px-4 max-sm:px-0 text-[18px] max-sm:text-[15px] font-bold text-[#292929] flex items-center py-4 max-xl:hidden">ë‚´ìš©</label>
          <div class="col-span-5 bg-[#FFFFFF] border border-[#EFEFEF] rounded-xl overflow-y-auto flex items-start "
          style="min-height: 300px; max-height: 800px; height: 100%;">
            <!-- ì—¬ê¸°ì— ë‚´ìš©ì´ ë“¤ì–´ê°‘ë‹ˆë‹¤ -->
            <div class="text-base leading-relaxed w-full flex-1 p-4" v-html="content"></div>
        </div>
      </div>


      <!-- íŒŒì¼ -->
      <div class="file-container px-2 bg-[#FFFFFF] border-b border-[#EFEFEF] flex items-center py-2">
        <label class="width px-4 py-2 max-sm:px-2 text-[18px] after-small font-bold text-[#292929] whitespace-nowrap">
          íŒŒì¼ 
        </label>
          <ul id="fileList" class="flex flex-col justify-start space-y-1 text-sm text-gray-700 list-none">
            <li
              v-for="(file, index) in existingFiles"
              :key="file.id"
              class="flex items-center gap-2 px-3 py-2 text-[16px] bg-gray-100 border rounded-md hover:bg-gray-200 border-gray-300"
            >
              <a :href="file.url" target="_blank" class="underline text-blue-600 hover:text-blue-800">
                  {{ file.name }}
              </a>
            </li>
          </ul>
      </div>

        
    </div>
    <div class="border-t-[2px] border-primaryPoint mt-5"></div>
    <!-- ë²„íŠ¼ -->
    <div class="max-w-[1190px] container mt-[64px] mb-[50px] max-sm:mt-[20px] ">
      <div class="max-w-[576px] flex gap-2 items-center justify-center max-sm:justify-end mx-auto">
        <button type="button" @click="handleDelete"
            class="deleteButton bg-[#FFEFF1] hover:bg-[#FFDFE3] px-4 py-2.5 max-sm:px-2.5 rounded-lg flex items-center border border-red-400">
            <img src="/img/training-mgmt/delete.png" alt="ì‚­ì œ ì•„ì´ì½˜" class="w-6 h-6"/>
            <span class="px-2 text-red-600 block max-lg:hidden">ì‚­ì œí•˜ê¸°</span>
        </button>
        <button type="button" @click="goToEdit"
            class="px-16 max-sm:px-6 py-2.5 text-white bg-primaryPoint rounded-[10px] hover:bg-[#648DDF]">
            ìˆ˜ì •í•˜ê¸°
        </button>
        <button type="button" @click="cancel"
            class="px-16 max-sm:px-6 py-2.5 bg-[#EBEBEB] rounded-[10px] hover:bg-[#EBEBEB] border border-[#DBDEE3]">
            ëª©ë¡ìœ¼ë¡œ
        </button>
      </div>
    </div>
  </form>
</template>

<script setup>

// definePageMeta({ middleware: 'auth' });

import { useState } from '#app'
import { useRouter, useRoute } from 'vue-router';
import Swal from 'sweetalert2'

const config = useRuntimeConfig() 
const token = useCookie('auth_token').value
const route = useRoute();
const router = useRouter();
const pageTitle = useState('pageTitle')

const title = ref('');
const content = ref('');
const status = ref('');
const type = ref('');
const created_at = ref('');
const existingFiles = ref([]);
const id = route.params.id;


// ğŸŒ API : ê³µì§€ì‚¬í•­ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
async function fetchNoticeData() {
  const id = route.params.id;
  if (!id) {
    console.error('ê³µì§€ì‚¬í•­ IDê°€ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }

  try {
    const { data, error } = await useFetch(`/api/admin/posts/${id}?board=notice`, {
      baseURL: config.public.backendUrl,
      headers: {
        Authorization: `Bearer ${token}`,
        Accept: 'application/json',
      },
    });

    if (error.value) {
      Swal.fire('ì˜¤ë¥˜', 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
      return;
    }

    if (data.value && data.value.data) {
      const d = data.value.data;
      type.value = d.board === 'notice' && d.category === 'ì¤‘ìš”' ? 'ì¤‘ìš”' : 'ì¼ë°˜';
      status.value = d.public === 1 ? 'ê³µê°œ' : 'ë¹„ê³µê°œ';
      title.value = d.title || '';
      content.value = d.content || '';
      created_at.value = formatDate(d.created_at || '-');
      existingFiles.value = d.files || [];
    }
  } catch (e) {
    Swal.fire('ì˜¤ë¥˜', 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
  }
}

// ğŸ› ï¸ ê¸°ëŠ¥ : ê³µì§€ì‚¬í•­ ìˆ˜ì •í•˜ê¸° ì´ë™
const goToEdit = () => {
  router.push(`/board/notice/edit/${route.params.id}`)
}
// ğŸ› ï¸ ê¸°ëŠ¥ : ëŒì•„ê°€ê¸° ë²„íŠ¼
function cancel() {
  router.push('/board/notice')
}

// ë‚ ì§œí¬ë§· ë°”ê¾¸ê¸°
function formatDate(dateString) {
  if (!dateString) return '';
  const d = new Date(dateString);
  const yy = String(d.getFullYear()).slice(2);
  const mm = String(d.getMonth() + 1).padStart(2, '0');
  const dd = String(d.getDate()).padStart(2, '0');
  return `${yy}.${mm}.${dd}`;
}


// ğŸŒ API : ì‚­ì œí•˜ê¸°
const handleDelete = async () => {
  if (!id) return;

  try {
    const result = await Swal.fire({
      title: 'ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
      text: 'ì‚­ì œ í›„ì—ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonText: 'ì˜ˆ, ì‚­ì œí•©ë‹ˆë‹¤',
      cancelButtonText: 'ì•„ë‹ˆì˜¤',
    });

    if (!result.isConfirmed) return;

    await $fetch(`/api/board/posts/${id}`, {
      baseURL: config.public.backendUrl,
      method: 'DELETE',
      headers: {
        'Content-Type': 'application/json',
        Authorization: `Bearer ${token}`,
      },
    });

    await Swal.fire({
      icon: 'success',
      title: 'ì‚­ì œ ì™„ë£Œ',
      text: `ê³µì§€ì‚¬í•­ì´ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`,
    });

    router.push('/board/notice')

  } catch (err) {
    console.error('âŒ ì‚­ì œ ì˜¤ë¥˜ ë°œìƒ:', err);
    await Swal.fire({
      icon: 'error',
      title: 'ì‚­ì œ ì‹¤íŒ¨',
      text: err.message || 'ì‚­ì œ ë„ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
    });
  }
};

onMounted(async () => {
  pageTitle.value = 'ê³µì§€ì‚¬í•­'
  const id = route.params.id
  await fetchNoticeData(id);
})

</script>

<style scoped>

.width {
  width: 17%; 
}
.file-container {
  grid-column: span 2 / span 2; 
}
.mob-br {
  display: none;
}
.context-wrap {
  grid-column: span 2 / span 2; 
}
.button-wrap {
  display: flex;
  width: 83.3333%;
  gap: 0.5rem;    
}
.context-container {
  grid-column: span 2 / span 2; 
  display: grid;          
  grid-template-columns: repeat(6, minmax(0, 1fr)); 
}
.context-label { 
  width: 16.666667%;
}
.tiny-mc { 
  grid-column: span 1 / span 1;
}
@media (max-width: 1280px) {
  .box {
    display: grid;
    grid-template-columns: 1fr;
  }
  .after-gray {
    background-color: #F9F9F9;
  }
  .after-white {
    background-color: #FFFFFF;
  }
  .wrap {
    width: 80%;
  }
  .context-wrap {
    grid-column: span 1 / span 1;
  }
  .context-container {
    grid-column: span 1 / span 1;   
    display: flex;                  
    flex-direction: column;     
    padding-top: 0;
  }
  .context-label {
    width: 38%; 
  }
  .width {
    width: 25%; 
  }
}

@media (max-width: 767px) {
  .mob-br {
    display: block;
  }
  .after-small {
    font-size: 16px;
  }
  .after-toosmall {
    font-size: 15px;
  }
  .box {
    padding-left: 0.5rem;
    padding-right: 0.5rem;
  }
  label {
    padding-left: 0.1rem;
    padding-right: 0.1rem;
  }
  .wrap {
    width: 100%;
  }
  .tighter {
    letter-spacing: -1px;
  } 
  .context-label {
    width: 30%; 
    justify-content: flex-start; 
  }
  .width {
    width: 30%; 
  }
}

</style>

